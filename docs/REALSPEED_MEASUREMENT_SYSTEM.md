# 실시간 보행속도 측정 및 활용 시스템

## 1. 시스템 개요

GPS와 가속도계를 융합한 하이브리드 센서 시스템으로 사용자의 실제 보행속도를 정밀하게 측정하고, 이를 개인화된 경로 예측에 활용하는 시스템입니다.

## 2. 실제 보행속도(realSpeed) 측정 과정

### 2.1 하이브리드 센서 데이터 수집

**GPS 센서**
- 위치 좌표를 1초 간격으로 추적
- 이동 속도 측정 (m/s 단위)
- Haversine 공식으로 이동 거리 계산

**가속도계 센서**
- 3축(X, Y, Z) 가속도를 1초 간격으로 측정
- 최근 20초간의 움직임 패턴을 버퍼에 저장
- 주기성과 강도를 분석하여 활동 유형 판별

**권한 요구사항**
- 가속도계: 일반 센서로 별도 권한 불필요
- GPS: 위치 권한 필요 (백그라운드 추적 포함)

### 2.2 활동 유형 자동 분류

시스템은 GPS와 가속도계 데이터를 3단계로 분석하여 사용자의 활동을 자동으로 분류합니다.

**1단계: GPS 속도 기반 1차 필터링**

GPS 속도가 0.3 m/s 미만인 경우, 가속도 변화량을 확인합니다:
- 변화량이 0.15 미만: 완전 정지 상태
- 변화량이 0.15 이상: 느리게 걷는 중

GPS 속도가 2.5 m/s를 초과하면 차량 탑승으로 판단합니다.

GPS 속도가 0.3~2.5 m/s 범위에 있으면 2단계 분석을 진행합니다.

**2단계: 가속도계 패턴 분석**

최근 20초간의 가속도 데이터를 분석하여 세 가지 특성을 추출합니다:
- **가속도 변화량**: 표준편차를 계산하여 움직임의 변동성 측정
- **주기성 감지**: 피크(최댓값) 간격을 분석하여 규칙적인 패턴 확인
- **평균 가속도 크기**: 움직임의 강도 측정

**3단계: 정밀 분류**

추출된 특성을 조합하여 활동을 최종 분류합니다:

### 2.3 구간별 데이터 수집

**구간 분류**
- **walking 구간**: GPS 속도와 가속도 패턴 분석으로 식별된 보행 구간
- **paused 구간**: 5초 이상 지속된 정지 구간 (신호대기, 차량 탑승 등)

**거리 측정 방식**

시스템은 매 초마다 사용자의 위치를 확인하고, 활동 유형이 걷기나 뛰기일 때만 거리를 누적합니다. 이를 통해 차량 이동 구간과 정지 구간의 거리는 자동으로 제외됩니다.

예를 들어, 대중교통을 이용하는 경우:
1. 정류장까지 걷기 → 거리 누적 ✓
2. 버스 대기 → 거리 누적 안 함
3. 버스 탑승 → 거리 누적 안 함 (차량으로 판단)
4. 하차 후 걷기 → 거리 누적 ✓

**품질 관리**

수집된 데이터의 신뢰성을 보장하기 위해 다음 검증을 수행합니다:
- 1초 미만의 짧은 구간은 무시
- walking 구간이지만 거리가 0.5m 미만인 경우 GPS 신호 불량으로 판단하여 제외
- 검증을 통과한 구간만 최종 데이터에 포함

### 2.4 실제 보행속도 계산

**계산 공식**

실제 보행속도 = 총 보행 거리 / 실제 걷는 시간

**계산 과정**

1. 전체 구간 중 walking 상태인 구간만 필터링
2. 필터링된 구간들의 거리를 모두 합산 (총 보행 거리)
3. 필터링된 구간들의 시간을 모두 합산 (실제 걷는 시간)
4. 거리를 시간으로 나누어 평균 보행속도 산출
5. paused 구간은 계산에서 완전히 제외

**출력 데이터**
- 실제 걷는 시간 (초)
- 정지 시간 (초)
- 실제 보행속도 (m/s)
- 정지 횟수
- 구간별 상세 데이터

## 3. 데이터베이스 저장

### 3.1 저장 구조

측정된 데이터는 `navigation_logs` 테이블에 다음과 같이 저장됩니다:

**기본 정보**
- `total_distance_m`: 전체 경로 거리 (대중교통 포함)
- `walking_distance_m`: 실제 보행 거리 (GPS+가속도계로 측정)
- `active_walking_time_seconds`: 실제 걷는 시간
- `paused_time_seconds`: 정지 시간
- `real_walking_speed_kmh`: 실제 보행속도
- `pause_count`: 정지 횟수

**상세 데이터**
- `movement_data`: 구간별 상세 정보 (JSONB 형식)

### 3.2 구간별 상세 데이터

`movement_data`는 각 구간의 세부 정보를 포함합니다:

**각 구간 정보**
- 시작/종료 시간
- 이동 거리 (미터)
- 지속 시간 (초)
- 평균 속도 (m/s)
- 상태 (walking 또는 paused)

**메타데이터**
- 감지 방식: GPS+가속도계 하이브리드
- 총 정지 횟수
- 횡단보도 대기 횟수 (선택적)

## 4. 실제 보행속도 활용

### 4.1 개인 기준 속도 역산

**역산의 필요성**

측정된 실제 속도에는 경사도와 날씨의 영향이 포함되어 있습니다. 예를 들어, 오르막길에서 비가 오는 날 측정한 속도는 사용자의 본래 능력보다 느릴 수밖에 없습니다. 따라서 이러한 환경 요인을 제거하여 사용자의 순수한 기준 속도(평지+맑은날 기준)를 도출해야 합니다.

**역산 방식**

기준 속도 = 실측 속도 × 경사도 계수 × 날씨 계수

여기서:
- 실측 속도: GPS+가속도계로 측정한 실제 보행속도
- 경사도 계수: 경사도가 보행에 미친 영향 
  (1.0 = 평지, 1.25 = 25% 느려짐)
- 날씨 계수: 날씨가 보행에 미친 영향 (1.0 = 맑음, 1.15 = 15% 느려짐)

계수가 1.0보다 크다는 것은 그만큼 사용자가 느려졌다는 의미이므로, 역산 시 곱해서 환경 영향을 제거합니다.

**구체적 예시**

실측 환경:
- 실측 속도: 3.2 km/h
- 경사도 계수: 1.25 (5% 오르막으로 25% 느려짐)
- 날씨 계수: 1.15 (비로 인해 15% 느려짐)

계산 결과:
- 기준 속도 = 3.2 × 1.25 × 1.15 = 4.6 km/h
- 해석: 평지에서 맑은 날이었다면 4.6 km/h로 걸었을 것

안전 범위: 2.0~8.0 km/h 범위로 제한하여 비정상적인 값 방지

### 4.2 자동 프로필 업데이트

**업데이트 조건**

다음 모든 조건을 만족할 때 자동으로 사용자 프로필을 업데이트합니다:
- 실제 보행속도 데이터가 존재
- 경사도 계수와 날씨 계수가 존재
- 실제 보행 시간이 5분(300초) 이상

**가중 평균 방식**

새로운 데이터를 반영할 때 기존 데이터와 가중 평균을 계산합니다:

새 평균 속도 = 기존 속도 × 0.7 + 새 속도 × 0.3

이는 기존에 축적된 데이터에 70%의 신뢰도를, 새로 측정된 데이터에 30%의 영향력을 부여하는 방식입니다.

**구체적 예시**

기존 프로필:
- 기존 평균 속도: 4.8 km/h (누적 데이터 15회)

새로운 측정:
- 새 역산 속도: 5.2 km/h

계산 과정:
- 새 평균 = 4.8 × 0.7 + 5.2 × 0.3 = 3.36 + 1.56 = 4.92 km/h

결과: 프로필 속도가 4.8 → 4.92 km/h로 완만하게 상승

**장점**
- 급격한 변동 방지: 한 번의 측정으로 프로필이 크게 바뀌지 않음 (최대 30% 영향)
- 장기 데이터 누적: 오래 사용할수록 정확도 향상
- 이상치 영향 최소화: 특이한 상황의 데이터가 전체에 미치는 영향 감소

### 4.3 개인화된 경로 예측

**예측 프로세스**

새로운 경로를 검색할 때 다음 단계로 예상 시간을 계산합니다:

1. **Tmap 기준 시간 획득**: Tmap API가 시속 4km 기준으로 계산한 보행 시간

2. **사용자 속도 계수 계산**: 
   - 데이터베이스에서 사용자의 평지+맑은날 기준 속도 조회
   - 사용자 계수 = 4.0 km/h / 사용자 기준 속도
   - 예: 사용자가 5 km/h이면 계수 0.8 (20% 빠름)
   - 예: 사용자가 3 km/h이면 계수 1.33 (33% 느림)

3. **경로 경사도 분석**: 
   - Google Elevation API로 고도 데이터 획득
   - Tobler's Hiking Function으로 경사도 계수 계산
   - 오르막일수록 계수 증가 (시간 증가)

4. **현재 날씨 조회**: 
   - 기상청 API를 통해 출발 시간의 날씨 확인
   - 비/눈/바람 정도에 따라 날씨 계수 산출

5. **최종 예상 시간 계산**: 
   예상 시간 = Tmap 기준 시간 × 사용자 계수 × 경사도 계수 × 날씨 계수

**실제 적용 예시**

사용자 정보:
- 기준 속도: 5.0 km/h (과거 데이터 학습 결과)
- 사용자 계수: 4.0 / 5.0 = 0.8

새 경로 조건:
- Tmap 기준 시간: 600초 (10분)
- 경사도: 3% 오르막 (계수 1.15)
- 날씨: 흐림 (계수 1.05)

계산 과정:
- 예상 시간 = 600 × 0.8 × 1.15 × 1.05 = 579초 ≈ 9.7분

결과: 
- Tmap은 "10분 소요"로 안내
- 우리 시스템은 "약 10분 소요"로 안내 (사용자가 빠르지만 오르막+흐림으로 상쇄)

**계수의 의미**
- 사용자 계수 < 1.0: 일반인보다 빠름 → 시간 단축
- 경사도 계수 > 1.0: 오르막/내리막 → 시간 증가
- 날씨 계수 > 1.0: 악천후 → 시간 증가

## 5. 시스템 장점

### 5.1 정확도 향상

**GPS 단독 사용의 한계**
- 느린 걷기와 완전 정지 구분 어려움
- 차량 저속 주행과 뛰기 혼동 가능
- 터널이나 실내에서 신호 불량

**GPS + 가속도계 융합의 이점**
- 움직임 패턴 분석으로 정확한 활동 분류
- 주기성 검사로 걷기/뛰기/차량 명확히 구분
- GPS 신호 불량 시에도 가속도계로 상태 유지

### 5.2 대중교통 호환성

**대중교통 이용 시 처리 방식**
- 버스/지하철 탑승 구간: 차량 또는 정지로 자동 분류
- 정류장까지의 보행 구간: walking으로 정확히 분류
- 최종 보행 거리: 순수 보행 구간만 합산

**결과**
- 대중교통 이용 중에도 실제 보행속도 정확히 측정
- 전체 경로 중 보행 비율 분석 가능
- 복합 이동 수단 사용 시에도 신뢰성 유지

### 5.3 데이터 신뢰성

**자동 검증 시스템**

저장된 데이터의 일관성을 자동으로 검증합니다. 보행 거리와 시간으로 직접 계산한 속도가 저장된 속도와 일치하는지 확인하여, 0.1 km/h 이상 차이나는 경우 오류로 감지합니다.

**검증 항목**
- 보행 거리 계산 정확성
- 시간 측정 정확성
- 속도 계산 일관성

### 5.4 학습 및 개선

**사용 단계별 정확도 향상**

초기 단계 (첫 사용):
- Health Connect 데이터가 있으면 해당 평균 속도 사용
- Health Connect 데이터가 없으면 시스템 기본값 (4.0 km/h) 사용
- 예측 정확도 낮음

데이터 누적 단계 (5~20회):
- 실제 이동 기록으로 개인 보행 패턴 파악 시작
- 10회 이상 측정 시 정확도 80% 이상
- 20회 이상 측정 시 정확도 90% 이상

장기 사용 단계:
- 시간대별 속도 패턴 분석 (아침/점심/저녁)
- 날씨별 영향도 세부 분석
- 계절별 변화 추적
- 개인 맞춤형 예측 모델 완성

## 6. 측정 데이터 예시

### 6.1 대중교통 경로
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[경로 안내 완료]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
총 거리: 8,500m (버스 7,200m + 보행 1,300m)
실제 보행 거리: 1,300m (GPS+가속도계)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
총 소요 시간: 28분 15초
실제 걷는 시간: 18분 30초 (1,110초)
정지/대기 시간: 9분 45초 (585초)
  - 신호대기: 4분 20초 (3회)
  - 버스 대기: 5분 25초 (1회)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
실제 보행속도: 4.22 km/h
  (1,300m ÷ 1,110초 × 3.6)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
환경 조건:
- 경사도 계수: 1.08 (완만한 오르막)
- 날씨 계수: 1.12 (흐리고 바람)

역산 기준속도: 5.10 km/h
  (4.22 × 1.08 × 1.12)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
프로필 업데이트: ✅ 자동 완료
이전: 4.95 km/h → 새로운: 5.02 km/h
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 6.2 도보 경로
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[경로 안내 완료]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
총 거리: 2,450m
실제 보행 거리: 2,450m
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
총 소요 시간: 36분 10초
실제 걷는 시간: 33분 25초 (2,005초)
정지 시간: 2분 45초 (165초)
  - 횡단보도: 2분 10초 (4회)
  - 기타: 35초 (2회)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
실제 보행속도: 4.40 km/h
  (2,450m ÷ 2,005초 × 3.6)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
환경 조건:
- 경사도 계수: 1.00 (평지)
- 날씨 계수: 1.00 (맑음)

역산 기준속도: 4.40 km/h
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
프로필 업데이트: ✅ 자동 완료
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 핵심 요약

**realSpeed 측정**: GPS 위치 추적 + 가속도계 패턴 분석으로 차량/정지 구간을 자동 제외하고 순수 보행 데이터만 추출

**환경 영향 제거**: 경사도와 날씨 계수를 역산하여 사용자의 개인화된 평지+맑은날 기준 속도 도출

**자동 학습**: 5분 이상 보행 시 자동으로 프로필 업데이트, 사용할수록 정확해지는 예측 제공

**신뢰성**: 하이브리드 센서 융합으로 GPS 단독 대비 정확도 향상, 대중교통 경로에서도 정확한 측정
